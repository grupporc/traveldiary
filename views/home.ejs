<!DOCTYPE html>
<html>
    <head>
        <title>Home</title>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <style>
            body {
                background-image: url('img/sfondo.gif');
                background-position: center;
                background-attachment: fixed;
                background-repeat: no-repeat;
                background-size: 100% 100%;
            }
            button {
                outline: none;
            }
        </style>
    </head>
    <body onload="getDiario();">
        <div class="w3-display-middle w3-center">
            <h4 class="w3-text-teal" style="text-align: left; font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;">Cerca Viaggio:</h4>
            <div class="w3-round-xlarge w3-pale-green w3-padding-large w3-border w3-border-teal">
                <form name="form" action='http://localhost:8888/cercaViaggio' method='POST' onsubmit="return validaForm();">
                    Città di partenza:
                    <input type="text" name="partenza" placeholder="Inserisci città">
                    <br><br>
                    Città di arrivo:
                    <input type="text" name="arrivo" placeholder="Inserisci città">
                    <br><br>
                    Data di partenza:
                    <input type="date" name="data" placeholder="yyyy-mm-dd" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}">
                    <br><br>
                    <button type="submit" class="w3-button w3-round-xlarge w3-border w3-border-teal w3-white w3-hover-teal">Cerca</button>
                </form>
            </div>
            <br><br>
            <p id="messaggio">Caricamento diario in corso...</p>
            <button id="diario" class="w3-btn w3-teal w3-padding-large w3-round-xlarge" style="opacity: 0.3;">
                Ottieni il tuo diario
            </button>
        </div>
    </body>
    <script>
        function validaForm()
        {
            var form = document.form;
            if(form.partenza.value=="")
            {
                alert("Inserisci una città di partenza");
                return false;
            }
            if(form.arrivo.value=="")
            {
                alert("Inserisci una città di arrivo");
                return false;
            }
            if(form.data.value=="")
            {
                alert("Inserisci una data di partenza");
                return false;
            }
            
            var date = form.data.value.split('-');
            
            var gg=parseInt(date[2]);
            var mm=parseInt(date[1]);
            var y=parseInt(date[0]);

            var dataAttuale= new Date();
            var g= dataAttuale.getDate();
            var m=dataAttuale.getMonth()+1;
            var a=dataAttuale.getFullYear();

            if(((gg>31 || gg<=0) && (mm>12 || mm<=0)) || y<a || (y==a && mm<m) || (y==a && mm==m && gg<g))
            {
                alert("Questa non è una data accettabile!!");
                return false;
            }
            
            return true;
        };
        function getDiario()
        {
            var req= new XMLHttpRequest();
            req.onreadystatechange = gestisciResponse;
            req.open('GET', 'http://localhost:8888/diario');
            req.send();
        };
        function gestisciResponse(e) 
        {
            if(e.target.readyState==4)
            {
                if(e.target.status==200)
                {
                    var risp=e.target.responseText;
                    if(risp=="errore")
                    {
                        document.getElementById("messaggio").innerHTML="ERRORE: Impossibile caricare diario!"; 
                    }
                    else
                    {
                        document.getElementById("messaggio").innerHTML="Il tuo diario è pronto!!";   
                        document.getElementById("diario").style.opacity=1;
                        document.getElementById('diario').addEventListener('click', function() {
                            window.location = 'http://localhost:8888/paginaDiario';
                        }, false);
                    }
                }
                else
                {
                    document.getElementById("messaggio").innerHTML="Errore: Impossibile caricare diario!";
                }
            }
        }
    </script>
</html>